{% extends "base.html" %}

{% block window_title %}{{ draft.title }} - Draft Mode{% endblock %}

{% block extra_css %}
<style>
/* Updated Editor Styles - Based on Figma Design */
.editor-layout {
    display: flex;
    height: calc(100vh - 120px);
    min-height: 600px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    overflow: hidden;
}

/* Left Sidebar */
.left-sidebar {
    width: 280px;
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-primary);
    display: flex;
    flex-direction: column;
    position: relative;
}

.sidebar-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-primary);
    background: var(--bg-tertiary);
}

.project-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.new-project-btn {
    padding: 6px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
    font-size: 12px;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.new-project-btn:hover {
    background: var(--accent-green);
    color: var(--bg-primary);
    border-color: var(--accent-green);
}

/* Version List */
.version-section {
    padding: 16px;
    flex: 1;
    overflow-y: auto;
}

.section-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--accent-green);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
    text-shadow: var(--glow-primary);
}

.version-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.version-item {
    padding: 8px 12px;
    margin-bottom: 4px;
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.version-item:hover {
    background: var(--bg-tertiary);
    border-color: var(--border-primary);
}

.version-item.active {
    background: var(--accent-green);
    color: var(--bg-primary);
    font-weight: 600;
    font-style: italic;
    border-color: var(--accent-green);
}

.version-badge {
    padding: 2px 6px;
    font-size: 8px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid;
    background: var(--bg-primary);
}

.version-badge.live {
    background: var(--accent-red);
    color: var(--text-primary);
    border-color: var(--accent-red);
}

.version-badge.final {
    background: var(--accent-green);
    color: var(--bg-primary);
    border-color: var(--accent-green);
}

.version-badge.review {
    background: var(--accent-blue);
    color: var(--text-primary);
    border-color: var(--accent-blue);
}

/* Main Editor Area */
.main-editor {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    background: var(--bg-primary);
}

.editor-header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border-primary);
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.editor-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.word-count {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.editor-container {
    flex: 1;
    position: relative;
    background: var(--bg-primary);
    padding: 24px;
}

.editor-textarea {
    width: 100%;
    height: 100%;
    border: none;
    outline: none;
    background: transparent;
    color: var(--text-primary);
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    line-height: 1.6;
    resize: none;
    white-space: pre-wrap;
    overflow-wrap: break-word;
}

.editor-textarea::placeholder {
    color: var(--text-muted);
    font-style: italic;
}

/* Right Sidebar */
.right-sidebar {
    width: 200px;
    background: var(--bg-secondary);
    border-left: 1px solid var(--border-primary);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.sidebar-button {
    padding: 12px 16px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    color: var(--text-primary);
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 8px;
}

.sidebar-button:hover {
    background: var(--accent-green);
    color: var(--bg-primary);
    border-color: var(--accent-green);
    box-shadow: var(--glow-primary);
}

.sidebar-button.primary {
    background: var(--accent-green);
    color: var(--bg-primary);
    border-color: var(--accent-green);
}

.sidebar-button.primary:hover {
    background: var(--text-primary);
    border-color: var(--text-primary);
}

/* Status indicator */
.save-status-indicator {
    position: absolute;
    top: 16px;
    right: 24px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 10px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent-green);
    box-shadow: 0 0 4px var(--accent-green);
    animation: pulse 2s infinite;
}

.status-dot.saving {
    background: var(--accent-yellow);
    box-shadow: 0 0 4px var(--accent-yellow);
}

.status-dot.error {
    background: var(--accent-red);
    box-shadow: 0 0 4px var(--accent-red);
}

/* Footer */
.editor-footer {
    background: var(--bg-tertiary);
    padding: 12px 24px;
    border-top: 1px solid var(--border-primary);
    font-size: 11px;
    color: var(--text-muted);
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Modal Updates */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 2000;
    backdrop-filter: blur(4px);
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg-secondary);
    border: 2px solid var(--border-primary);
    border-radius: 8px;
    padding: 24px;
    min-width: 400px;
    max-width: 90vw;
    box-shadow: 0 8px 32px rgba(0, 255, 65, 0.2);
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border-primary);
}

.modal-title {
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: 1px solid var(--border-primary);
    color: var(--text-muted);
    cursor: pointer;
    padding: 6px 10px;
    font-size: 12px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    color: var(--accent-red);
    border-color: var(--accent-red);
}

.form-group {
    margin-bottom: 16px;
}

.form-label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
}

.form-input {
    width: 100%;
    padding: 10px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    color: var(--text-primary);
    font-family: inherit;
    font-size: 12px;
    transition: all 0.2s ease;
}

.form-input:focus {
    outline: none;
    border-color: var(--accent-green);
    box-shadow: 0 0 0 1px var(--accent-green);
}

.button-group {
    margin-top: 20px;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .editor-layout {
        flex-direction: column;
        height: auto;
    }
    
    .left-sidebar {
        width: 100%;
        max-height: 200px;
        order: 1;
    }
    
    .right-sidebar {
        width: 100%;
        order: 3;
        border-left: none;
        border-top: 1px solid var(--border-primary);
        flex-direction: row;
        flex-wrap: wrap;
        padding: 12px;
        gap: 8px;
    }
    
    .main-editor {
        order: 2;
        min-height: 400px;
    }
    
    .sidebar-button {
        flex: 1;
        min-width: calc(50% - 4px);
        padding: 8px 12px;
        text-align: center;
        justify-content: center;
    }
    
    .version-section {
        max-height: 120px;
        overflow-y: auto;
    }
    
    .editor-container {
        padding: 16px;
    }
}

@media (max-width: 480px) {
    .left-sidebar {
        max-height: 150px;
    }
    
    .sidebar-header {
        padding: 12px;
    }
    
    .version-section {
        padding: 12px;
        max-height: 100px;
    }
    
    .editor-header {
        padding: 12px 16px;
    }
    
    .right-sidebar {
        padding: 8px;
    }
    
    .sidebar-button {
        font-size: 10px;
        padding: 6px 8px;
    }
}
</style>
{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{{ url_for('main.dashboard') }}" style="font-size: 10px;">Dashboard</a>
    <span class="breadcrumb-separator" style="font-size: 10px;">►</span>
    <span style="color: var(--accent-green); font-size: 10px;">{{ draft.title }}</span>
</div>
{% endblock %}

{% block content %}
<div class="editor-layout">
    <!-- Left Sidebar -->
    <div class="left-sidebar">
        <div class="sidebar-header">
            <div class="project-title">{{ draft.title }}</div>
            <a href="{{ url_for('drafts.create_draft') }}" class="new-project-btn">
                📄 New Project
            </a>
        </div>
        
        <div class="version-section">
            <div class="section-title">Versions</div>
            <ul class="version-list">
                {% for version in versions %}
                <li class="version-item {% if version.id == current_version.id %}active{% endif %}" 
                    onclick="switchVersion({{ version.id }})">
                    <span>{{ version.version_name }}</span>
                    {% if version.tag == 'final' %}
                        <span class="version-badge final">FINAL</span>
                    {% elif version.tag == 'ready_for_review' %}
                        <span class="version-badge review">REVIEW</span>
                    {% elif version.tag == 'working' %}
                        <span class="version-badge live">LIVE</span>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
            
            <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-primary);">
                <button id="newVersionBtn" class="sidebar-button" style="width: 100%; justify-content: center;">
                    + New Version
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Editor -->
    <div class="main-editor">
        <div class="editor-header">
            <div class="editor-title">{{ current_version.version_name }}</div>
            <div class="word-count" id="wordCount">0 Words</div>
        </div>
        
        <div class="save-status-indicator">
            <div class="status-dot" id="saveIndicator"></div>
            <span id="saveStatus">Ready</span>
        </div>
        
        <div class="editor-container">
            <textarea 
                id="contentEditor" 
                class="editor-textarea" 
                placeholder="## Version {{ current_version.version_name }}
# Start writing your content here...

Use Markdown formatting:
- **Bold text** and *italic text*
- Code blocks with ```
- Lists and headers
- > Blockquotes

Start typing to see your content come to life..."
            >{{ current_version.content }}</textarea>
        </div>
    </div>
    
    <!-- Right Sidebar -->
    <div class="right-sidebar">
        <button id="saveBtn" class="sidebar-button primary">
            💾 Save
        </button>
        
        <button id="previewBtn" class="sidebar-button">
            👁️ Preview
        </button>
        
        <button id="compareBtn" class="sidebar-button">
            🔍 Compare
        </button>
        
        <button id="assistBtn" class="sidebar-button">
            ✨ Assist
        </button>
        
        <button id="shareBtn" class="sidebar-button">
            🔗 Share
        </button>
        
        <button id="metadataBtn" class="sidebar-button">
            📋 Metadata
        </button>
        
        <div style="margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border-primary);">
            <button id="exportBtn" class="sidebar-button">
                📁 Export MD
            </button>
        </div>
    </div>
</div>

<div class="editor-footer">
    © 2025 Draft Mode • Made with ❤️ by Recommended Systems
</div>

<!-- New Version Modal -->
<div id="newVersionModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Create New Version</h3>
            <button class="modal-close" id="closeModalBtn">✕</button>
        </div>
        <div class="form-group">
            <label class="form-label">Version Name</label>
            <input type="text" id="newVersionName" class="form-input" placeholder="e.g. v2.0, Draft 2, Final Edit">
        </div>
        <div class="button-group">
            <button id="cancelVersionBtn" class="sidebar-button">Cancel</button>
            <button id="createVersionBtn" class="sidebar-button primary">Create Version</button>
        </div>
    </div>
</div>

<!-- Compare Modal -->
<div id="compareModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Compare Versions</h3>
            <button class="modal-close" id="closeCompareModalBtn">✕</button>
        </div>
        <div class="form-group">
            <label class="form-label">Compare Against</label>
            <select id="compareVersion" class="form-input">
                <option value="">Select version...</option>
                {% for version in versions %}
                    {% if version.id != current_version.id %}
                    <option value="{{ version.id }}">{{ version.version_name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="button-group">
            <button id="cancelCompareBtn" class="sidebar-button">Cancel</button>
            <button id="executeCompareBtn" class="sidebar-button primary">Compare</button>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div id="shareModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Share Version</h3>
            <button class="modal-close" id="closeShareModalBtn">✕</button>
        </div>
        <div style="margin-bottom: 16px;">
            <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">
                Generate a public link to share this version with others.
            </p>
            <div id="shareLinkContainer" style="display: none;">
                <label class="form-label">Share Link:</label>
                <div style="padding: 8px; background: var(--bg-primary); border: 1px solid var(--border-primary); font-size: 10px; color: var(--text-secondary); word-break: break-all;" id="shareLink"></div>
            </div>
        </div>
        <div class="button-group">
            <button id="cancelShareBtn" class="sidebar-button">Cancel</button>
            <button id="generateShareLinkBtn" class="sidebar-button primary">Generate Link</button>
            <button id="copyLinkBtn" class="sidebar-button" style="display: none;">Copy Link</button>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal-overlay">
    <div class="modal-content" style="min-width: 800px; max-width: 95vw;">
        <div class="modal-header">
            <h3 class="modal-title">Live Preview</h3>
            <button class="modal-close" id="closePreviewModalBtn">✕</button>
        </div>
        <div id="previewContent" style="padding: 20px; background: var(--bg-primary); border: 1px solid var(--border-primary); max-height: 400px; overflow-y: auto; font-size: 14px; line-height: 1.6;">
            <!-- Preview content will be loaded here -->
        </div>
        <div class="button-group">
            <button id="closePreviewBtn" class="sidebar-button">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentVersionId = {{ current_version.id }};
    let draftId = {{ draft.id }};
    let autoSaveTimeout;
    let lastSavedContent = document.getElementById('contentEditor').value;
    
    // Word count update
    function updateWordCount() {
        const content = document.getElementById('contentEditor').value;
        const words = content.trim().split(/\s+/).filter(word => word.length > 0).length;
        document.getElementById('wordCount').textContent = `${words} Words`;
    }
    
    // Version switching
    function switchVersion(versionId) {
        if (versionId && versionId != currentVersionId) {
            const content = document.getElementById('contentEditor').value;
            if (content !== lastSavedContent) {
                if (confirm('You have unsaved changes. Save before switching versions?')) {
                    saveContent().then(() => {
                        window.location.href = `/drafts/${draftId}?version=${versionId}`;
                    });
                    return;
                }
            }
            window.location.href = `/drafts/${draftId}?version=${versionId}`;
        }
    }
    
    // Save status management
    function updateSaveStatus(status, type = 'ready') {
        const indicator = document.getElementById('saveIndicator');
        const statusText = document.getElementById('saveStatus');
        
        indicator.className = 'status-dot';
        if (type === 'saving') indicator.classList.add('saving');
        if (type === 'error') indicator.classList.add('error');
        
        statusText.textContent = status;
    }
    
    // Save content
    function saveContent() {
        const content = document.getElementById('contentEditor').value;
        updateSaveStatus('Saving...', 'saving');
        
        return fetch(`/drafts/versions/${currentVersionId}/save`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                lastSavedContent = content;
                updateSaveStatus('Saved', 'ready');
                return true;
            } else {
                updateSaveStatus('Failed', 'error');
                return false;
            }
        })
        .catch(() => {
            updateSaveStatus('Failed', 'error');
            return false;
        });
    }
    
    // Auto-save
    function autoSave() {
        const content = document.getElementById('contentEditor').value;
        if (content !== lastSavedContent) {
            saveContent();
        }
    }
    
    // Preview update
    function updatePreview() {
        const content = document.getElementById('contentEditor').value;
        
        fetch(`/drafts/versions/${currentVersionId}/preview`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('previewContent').innerHTML = data.html;
        })
        .catch(() => {
            document.getElementById('previewContent').innerHTML = '<p style="color: var(--accent-red);">Preview unavailable</p>';
        });
    }
    
    // Event listeners
    document.getElementById('contentEditor').addEventListener('input', function() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(autoSave, 2000);
        updateWordCount();
    });
    
    document.getElementById('saveBtn').addEventListener('click', saveContent);
    
    // Modal management
    function showModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }
    
    function hideModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    // New version modal
    document.getElementById('newVersionBtn').addEventListener('click', () => showModal('newVersionModal'));
    document.getElementById('closeModalBtn').addEventListener('click', () => hideModal('newVersionModal'));
    document.getElementById('cancelVersionBtn').addEventListener('click', () => hideModal('newVersionModal'));
    
    // Compare modal
    document.getElementById('compareBtn').addEventListener('click', () => showModal('compareModal'));
    document.getElementById('closeCompareModalBtn').addEventListener('click', () => hideModal('compareModal'));
    document.getElementById('cancelCompareBtn').addEventListener('click', () => hideModal('compareModal'));
    
    // Share modal
    document.getElementById('shareBtn').addEventListener('click', () => showModal('shareModal'));
    document.getElementById('closeShareModalBtn').addEventListener('click', () => hideModal('shareModal'));
    document.getElementById('cancelShareBtn').addEventListener('click', () => hideModal('shareModal'));
    
    // Preview modal
    document.getElementById('previewBtn').addEventListener('click', () => {
        updatePreview();
        showModal('previewModal');
    });
    document.getElementById('closePreviewModalBtn').addEventListener('click', () => hideModal('previewModal'));
    document.getElementById('closePreviewBtn').addEventListener('click', () => hideModal('previewModal'));
    
    // Create version
    document.getElementById('createVersionBtn').addEventListener('click', function() {
        const versionName = document.getElementById('newVersionName').value.trim();
        if (!versionName) {
            alert('Please enter a version name');
            return;
        }
        
        const content = document.getElementById('contentEditor').value;
        const formData = new FormData();
        formData.append('version_name', versionName);
        formData.append('content', content);
        
        fetch(`/drafts/${draftId}/versions`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    });
    
    // Compare versions
    document.getElementById('executeCompareBtn').addEventListener('click', function() {
        const compareVersionId = document.getElementById('compareVersion').value;
        if (compareVersionId) {
            window.open(`/drafts/compare/${currentVersionId}/${compareVersionId}`, '_blank');
            hideModal('compareModal');
        }
    });
    
    // Generate share link
    document.getElementById('generateShareLinkBtn').addEventListener('click', function() {
        fetch(`/drafts/versions/${currentVersionId}/share`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('shareLink').textContent = data.share_url;
                document.getElementById('shareLinkContainer').style.display = 'block';
                document.getElementById('copyLinkBtn').style.display = 'inline-block';
            }
        });
    });
    
    // Copy link
    document.getElementById('copyLinkBtn').addEventListener('click', function() {
        const shareLink = document.getElementById('shareLink').textContent;
        navigator.clipboard.writeText(shareLink).then(() => {
            this.textContent = 'Copied!';
            setTimeout(() => {
                this.textContent = 'Copy Link';
            }, 2000);
        });
    });
    
    // Export functionality
    document.getElementById('exportBtn').addEventListener('click', function() {
        const content = document.getElementById('contentEditor').value;
        const blob = new Blob([content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `{{ draft.title }}.md`;
        a.click();
        URL.revokeObjectURL(url);
    });
    
    // Close modals on outside click
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 's':
                    e.preventDefault();
                    saveContent();
                    break;
                case 'n':
                    e.preventDefault();
                    showModal('newVersionModal');
                    break;
                case 'p':
                    e.preventDefault();
                    updatePreview();
                    showModal('previewModal');
                    break;
            }
        }
    });
    
    // Initialize
    updateWordCount();
    updateSaveStatus('Ready', 'ready');
</script>
{% endblock %}